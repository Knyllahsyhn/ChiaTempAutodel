#! /bin/bash                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        ### HELP ###                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              display_help () {                                                                                                                                                                                                                                                                                                            echo "Usage: $0 [-f] [-c] log_directory"                                                                                                                                                                                                                                                                                     echo                                                                                                                                                                                                                                                                                                                         echo "  -f    delete logs of failed plots"                                                                                                                                                                                                                                                                                   echo "  -c delete logs of completed plots"                                                                                                                                                                                                                                                                                   echo                                                                                                                                                                                                                                                                                                                         echo "  If no log directory is specified, user will be prompted"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       }                                                                                                                                                                                                                                                                                                                            ######                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 ### Parse Opts ###                                                                                                                                                                                                                                                                                                           while getopts fch flag                                                                                                                                                                                                                                                                                                       do                                                                                                                                                                                                                                                                                                                                   case "${flag}" in                                                                                                                                                                                                                                                                                                                    f)logf=1;;                                                                                                                                                                                                                                                                                                                   c)logc=1;;                                                                                                                                                                                                                                                                                                                   h)display_help;exit;;                                                                                                                                                                                                                                                                                                        \?)exit 42;;                                                                                                                                                                                                                                                                                                         esac                                                                                                                                                                                                                                                                                                                 done                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      shift $((OPTIND - 1))                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     DIR=$1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ######                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if [ -z "${DIR}" ]                                                                                                                                                                                                                                                                                                           then                                                                                                                                                                                                                                                                                                                                 read -p 'Enter log directory: ' DIR                                                                                                                                                                                                                                                                                  fi                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if [ ! -e "$DIR" ]                                                                                                                                                                                                                                                                                                           then                                                                                                                                                                                                                                                                                                                                 echo "Directory does not exist!"                                                                                                                                                                                                                                                                                             exit 4                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            elif [ ! -d "$DIR" ]                                                                                                                                                                                                                                                                                                         then                                                                                                                                                                                                                                                                                                                                 echo "Not a directory!"                                                                                                                                                                                                                                                                                                      exit 5                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            else                                                                                                                                                                                                                                                                                                                                 echo "Path is okay"                                                                                                                                                                                                                                                                                                          echo                                                                                                                                                                                                                                                                                                                         cd ${DIR}                                                                                                                                                                                                                                                                                                            fi                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ### Find and delete .tmp files with corresponding plot id ###                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          delete() {                                                                                                                                                                                                                                                                                                                   for f in $(ls ${1} | grep ${2})                                                                                                                                                                                                                                                                                              do                                                                                                                                                                                                                                                                                                                                   rm --recursive --force --verbose ${1}/${f}                                                                                                                                                                                                                                                                           done                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      }                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         #####                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               # Get Plot IDs, pids and temp dir from plotter log files and decide whether do delete                                                                                                                                                                                                                                        # corresponding temp files based on plotting status                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    check() {                                                                                                                                                                                                                                                                                                                                    local id=$(grep --extended-regexp "ID" --max-count=1 "${1}" | cut --delimiter=':' --fields=2)                                                                                                                                                                                                                                local pid=$(grep --extended-regexp "Process" ${1} | tr --delete ' ' | cut --delimiter=':' --field=2)                                                                                                                                                                                                                         local tmpdir=$(grep -E "tmp" -m 1 ${1} | cut -d ':' -f 2 | cut -d ' ' -f 2 | tr -d '_' )                                                                                                                                                                                                                                     if grep --extended-regexp "Summary" ${1};       # If completion of plot with $id has been logged                                                                                                                                                                                                                             then                                                                                                                                                                                                                                                                                                                                 echo "Plot "${id}" finished, looking for tmp files to delete...\n"                                                                                                                                                                                                                                                           delete ${tmpdir} ${id}                                                                                                                                                                                                                                                                                                       sleep 1                                                                                                                                                                                                                                                                                                                      if [ "$logc" = 1  ]                                                                                                                                                                                                                                                                                                          then                                                                                                                                                                                                                                                                                                                                 echo "Removing log\n"                                                                                                                                                                                                                                                                                                        echo $2                                                                                                                                                                                                                                                                                                                      rm --verbose --force ${1}                                                                                                                                                                                                                                                                                            fi                                                                                                                                                                                                                                                                                                                   elif [ -z "$(ps --pid ${pid} --format pid=)" ]          # If plot has not been completed, but process is killed, i.e. plot failed. Checks if pid exists.                                                                                                                                                                     then                                                                                                                                                                                                                                                                                                                                 echo "Plot "${id}" failed, deleting stale temp files in 3, 2, 1..."                                                                                                                                                                                                                                                          sleep 1                                                                                                                                                                                                                                                                                                                      delete ${tmpdir} ${id}                                                                                                                                                                                                                                                                                                       if [ "$logf" = 1 ]                                                                                                                                                                                                                                                                                                           then                                                                                                                                                                                                                                                                                                                                 echo "Removing log\n"                                                                                                                                                                                                                                                                                                        echo ${1}                                                                                                                                                                                                                                                                                                                    rm --verbose --force ${1}                                                                                                                                                                                                                                                                                            fi                                                                                                                                                                                                                                                                                                                   else                                            # Plot still running, no completion logged, pid exists                                                                                                                                                                                                                               echo ""${id}" still plotting at "${pid}"! Not removing tmp files...\n"                                                                                                                                                                                                                                               fi                                                                                                                                                                                                                                                                                                           }                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             for file in ${DIR}/*.log;                                                                                                                                                                                                                                                                                                    do                                                                                                                                                                                                                                                                                                                           check ${file}                                                                                                                                                                                                                                                                                                                done                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 #! /bin/bash



### HELP ###

display_help () {
echo "Usage: $0 [-f] [-c] log_directory"
echo
echo "  -f    delete logs of failed plots"
echo "  -c delete logs of completed plots"
echo
echo "  If no log directory is specified, user will be prompted"


}
######


### Parse Opts ###
while getopts fch flag
do
        case "${flag}" in
                f)logf=1;;
                c)logc=1;;
                h)display_help;exit;;
                \?)exit 42;;
        esac
done

shift $((OPTIND - 1))

DIR=$1

######





if [ -z "${DIR}" ]
then
        read -p 'Enter log directory: ' DIR
fi

if [ ! -e "$DIR" ]
then
        echo "Directory does not exist!"
        exit 4

elif [ ! -d "$DIR" ]
then
        echo "Not a directory!"
        exit 5

else
        echo "Path is okay"
        echo
        cd ${DIR}
fi



### Find and delete .tmp files with corresponding plot id ###


delete() {
for f in $(ls ${1} | grep ${2})
do
        rm --recursive --force --verbose ${1}/${f}
done

}

#####



# Get Plot IDs, pids and temp dir from plotter log files and decide whether do delete
# corresponding temp files based on plotting status


check() {
                local id=$(grep --extended-regexp "ID" --max-count=1 "${1}" | cut --delimiter=':' --fields=2)
                local pid=$(grep --extended-regexp "Process" ${1} | tr --delete ' ' | cut --delimiter=':' --field=2)
                local tmpdir=$(grep -E "tmp" -m 1 ${1} | cut -d ':' -f 2 | cut -d ' ' -f 2 | tr -d '_' )
                if grep --extended-regexp "Summary" ${1};       # If completion of plot with $id has been logged
                then
                        echo "Plot "${id}" finished, looking for tmp files to delete...\n"
                        delete ${tmpdir} ${id}
                        sleep 1
                        if [ "$logc" = 1  ]
                        then
                                echo "Removing log\n"
                                echo $2
                                rm --verbose --force ${1}
                        fi
                elif [ -z "$(ps --pid ${pid} --format pid=)" ]          # If plot has not been completed, but process is killed, i.e. plot failed. Checks if pid exists.
                then
                        echo "Plot "${id}" failed, deleting stale temp files in 3, 2, 1..."
                        sleep 1
                        delete ${tmpdir} ${id}
                        if [ "$logf" = 1 ]
                        then
                                echo "Removing log\n"
                                echo ${1}
                                rm --verbose --force ${1}
                        fi
                else                                            # Plot still running, no completion logged, pid exists
                        echo ""${id}" still plotting at "${pid}"! Not removing tmp files...\n"
                fi
}





for file in ${DIR}/*.log;
do
check ${file}
done

exit
